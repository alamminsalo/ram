BEGIN;

-- base tables
{{~#each models}}
{{~#if is_object}}
{{~#if (ne (ext "x-sql") "skip")}}
DROP TABLE IF EXISTS {{snakecase name}};
CREATE TABLE {{snakecase name}} (
  {{~#each primitive_properties}}
  {{r (snakecase name)}} {{type}} {{#unless nullable}}NOT NULL{{/unless}}{{#unless @last}},{{/unless}}
  {{~/each}}
);
{{~/if}}
{{~/if}}
{{~/each}}

-- set primary keys
{{~#each models}}
{{~#if is_object}}
{{~#if (ne (ext "x-sql") "skip")}}
{{~#each primitive_properties}}
{{~#if (eq (snakecase name) "id")}}
CREATE SEQUENCE {{snakecase ../name}}_id_seq;
ALTER TABLE {{snakecase ../name}} ALTER COLUMN {{r (snakecase name)}} SET DEFAULT nextval('{{snakecase ../name}}_id_seq');
ALTER TABLE {{snakecase ../name}} ALTER COLUMN {{r (snakecase name)}} SET NOT NULL;
ALTER SEQUENCE {{snakecase ../name}}_id_seq OWNED BY {{snakecase ../name}}.id;
ALTER TABLE {{snakecase ../name}} ADD PRIMARY KEY (id);
{{~/if}}
{{~/each}}
{{~/if}}
{{~/if}}
{{~/each}}

-- fk relations
{{~#each models}}
{{~#if is_object}}
{{~#if (ne (ext "x-sql") "skip")}}
{{~#each object_properties}}
ALTER TABLE {{snakecase ../name}} ADD COLUMN {{r (snakecase name)}} int {{#unless nullable}}NOT NULL{{/unless}} REFERENCES {{snakecase type}}(id);
{{~/each}}
{{~/if}}
{{~/if}}
{{~/each}}

-- TODO: many2many tables

COMMIT;
